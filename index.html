<script>
const API_BASE = "https://data-cleaner-backend.onrender.com";

/* Elements */
const form = document.getElementById("cleanForm");
const btn = document.getElementById("submitBtn");
const progress = document.getElementById("progress");

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const fileName = document.getElementById("fileName");

const previewSection = document.getElementById("previewSection");
const previewBefore = document.getElementById("previewBefore");
const previewAfter = document.getElementById("previewAfter");
const downloadLink = document.getElementById("downloadLink");

/* Dark mode */
const toggle = document.getElementById("themeToggle");
if (localStorage.theme === "dark") {
    document.body.classList.add("dark");
    toggle.textContent = "â˜€ Light";
}
toggle.onclick = () => {
    document.body.classList.toggle("dark");
    const dark = document.body.classList.contains("dark");
    localStorage.theme = dark ? "dark" : "light";
    toggle.textContent = dark ? "â˜€ Light" : "ðŸŒ™ Dark";
};

/* Upload click */
dropZone.onclick = () => fileInput.click();

fileInput.onchange = () => {
    fileName.textContent = fileInput.files[0]?.name || "";
};

/* Drag & drop */
dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    fileInput.files = e.dataTransfer.files;
    fileName.textContent = fileInput.files[0]?.name || "";
});

/* Submit */
form.onsubmit = async e => {
    e.preventDefault();
    if (!fileInput.files.length) return alert("Please select a file");

    btn.disabled = true;
    progress.style.display = "block";

    try {
        const fd = new FormData();
        fd.append("file", fileInput.files[0]);

        document.querySelectorAll("input[type=checkbox]").forEach(c => {
            if (c.checked) fd.append(c.name, "true");
        });

        const res = await fetch(`${API_BASE}/clean`, {
            method: "POST",
            body: fd
        });

        if (!res.ok) throw new Error("Cleaning failed");

        const data = await res.json();

        previewBefore.innerHTML = renderTable(data.preview_before);
        previewAfter.innerHTML = renderTable(data.preview_after);
        downloadLink.href = API_BASE + data.download_url;

        previewSection.style.display = "block";
    } catch (err) {
        alert("Something went wrong. Please try again.");
        console.error(err);
    } finally {
        progress.style.display = "none";
        btn.disabled = false;
    }
};

function renderTable(rows) {
    if (!rows || !rows.length) return "<p>No data</p>";

    let html = "<table><tr>";
    Object.keys(rows[0]).forEach(k => html += `<th>${k}</th>`);
    html += "</tr>";

    rows.forEach(r => {
        html += "<tr>";
        Object.values(r).forEach(v => html += `<td>${v ?? ""}</td>`);
        html += "</tr>";
    });

    return html + "</table>";
}
</script>
