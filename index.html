<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel Data Cleaner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --accent: #4f46e5;
            --border: #e5e7eb;
            --drop-bg: #eef2ff;
            --success: #10b981;
        }

        body.dark {
            --bg-main: #0f172a;
            --bg-card: #020617;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --accent: #818cf8;
            --border: #1e293b;
            --drop-bg: #020617;
        }

        * { box-sizing: border-box; font-family: "Segoe UI", system-ui, sans-serif; }

        body {
            margin: 0;
            min-height: 100vh;
            padding: 40px;
            display: flex;
            justify-content: center;
            color: var(--text-main);
            background: linear-gradient(135deg, #eef2ff, #fdf2f8, #ecfeff);
            background-size: 300% 300%;
            animation: gradientMove 12s ease infinite;
        }

        body.dark { background: linear-gradient(135deg, #020617, #0f172a, #020617); }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container { max-width: 1100px; width: 100%; }

        .card {
            backdrop-filter: blur(14px);
            padding: 45px;
            border-radius: 22px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.95));
        }

        body.dark .card { background: linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.95)); }

        .header { display:flex; justify-content:space-between; align-items:center; }

        .toggle { cursor:pointer; padding:8px 14px; border-radius:999px; background:var(--drop-bg); }

        .tabs { display:flex; gap:12px; margin-top:25px; }

        .tab { flex:1; padding:12px; border-radius:12px; cursor:pointer; font-weight:700; text-align:center; background:var(--border); }

        .tab.active { background:linear-gradient(135deg,#4f46e5,#6366f1); color:white; }

        .drop-zone { margin-top: 30px; border: 2px dashed var(--accent); border-radius: 18px; padding: 45px; text-align: center; cursor: pointer; }

        .drop-zone.dragover { background: rgba(79,70,229,0.15); }

        .file-name { margin-top:10px; font-weight:600; }

        input[type=file] { display:none; }

        button {
            width:100%;
            margin-top:30px;
            padding:15px;
            font-size:16px;
            font-weight:700;
            border-radius:14px;
            border:none;
            background:linear-gradient(135deg,#4f46e5,#6366f1);
            color:white;
            cursor:pointer;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.98); }

        #downloadBtn { background: linear-gradient(135deg, #10b981, #059669); margin-bottom: 20px; }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; background: var(--bg-card); font-size: 14px; }

        th { background: var(--accent); color: white; padding: 12px; text-align: left; position: sticky; top: 0; }

        td { padding: 10px; border-bottom: 1px solid var(--border); white-space: nowrap; }

        tr:hover { background: var(--drop-bg); }

        .progress-wrap { display:none; margin-top:18px; }

        .progress-bar { height:10px; width:100%; background:var(--border); border-radius:999px; overflow:hidden; }

        .progress-bar span {
            display:block; height:100%; width:30%;
            background:linear-gradient(90deg,var(--accent),#22d3ee);
            animation:loading 1.2s infinite;
        }

        @keyframes loading { from { transform:translateX(-100%); } to { transform:translateX(400%); } }
    </style>
</head>

<body>
<div class="container">
    <div class="card">
        <div class="header">
            <h2>Excel Data Cleaner</h2>
            <div class="toggle" id="themeToggle">ðŸŒ™ Dark</div>
        </div>

        <div class="tabs">
            <div class="tab active" id="cleanTab">ðŸ§¹ Clean Excel</div>
            <div class="tab" id="macroTab">âš™ Run Macro</div>
        </div>

        <div id="cleanSection">
            <form id="cleanForm">
                <div class="drop-zone" id="dropZone">
                    ðŸ“‚ Upload Excel / CSV
                    <div class="file-name" id="fileName"></div>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" required>
                <button type="submit">Clean & Preview</button>

                <div class="progress-wrap" id="progress">
                    <div class="progress-bar"><span></span></div>
                </div>
            </form>

            <div id="previewSection" style="display:none; margin-top: 30px;">
                <button id="downloadBtn">ðŸ“¥ Download Cleaned File</button>
                
                <h4>Preview: After Cleaning</h4>
                <div id="previewAfter" class="table-container"></div>
                
                <h4>Preview: Before Cleaning</h4>
                <div id="previewBefore" class="table-container"></div>
            </div>
        </div>

        <div id="macroSection" style="display:none;">
            <div class="drop-zone" id="macroExcelZone">
                ðŸ“„ Upload Excel
                <div class="file-name" id="macroExcelName"></div>
            </div>
            <input type="file" id="macroExcel" accept=".csv,.xls,.xlsx">

            <div class="drop-zone" id="macroBasZone">
                ðŸ“œ Upload .bas file
                <div class="file-name" id="macroBasName"></div>
            </div>
            <input type="file" id="macroBas" accept=".bas">

            <button id="runMacroBtn">Run Macro</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = "https://data-cleaner-backend.onrender.com";

    /* THEME */
    themeToggle.onclick = () => {
        document.body.classList.toggle("dark");
        themeToggle.textContent = document.body.classList.contains("dark") ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
    };

    /* TABS */
    cleanTab.onclick = () => {
        cleanTab.classList.add("active"); macroTab.classList.remove("active");
        cleanSection.style.display = "block"; macroSection.style.display = "none";
    };

    macroTab.onclick = () => {
        macroTab.classList.add("active"); cleanTab.classList.remove("active");
        macroSection.style.display = "block"; cleanSection.style.display = "none";
    };

    /* TABLE GENERATOR */
    function createTable(data) {
        if (!data || !data.length) return "<p style='padding:20px;'>No data available</p>";
        let keys = Object.keys(data[0]);
        let html = `<table><thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead><tbody>`;
        data.forEach(row => {
            html += `<tr>${keys.map(k => `<td>${row[k] ?? ''}</td>`).join('')}</tr>`;
        });
        return html + `</tbody></table>`;
    }

    /* CLEAN LOGIC */
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = () => fileName.textContent = fileInput.files[0]?.name || "";

    cleanForm.onsubmit = async e => {
        e.preventDefault();
        if (!fileInput.files[0]) return;
        
        progress.style.display = "block";
        previewSection.style.display = "none";

        const fd = new FormData();
        fd.append("file", fileInput.files[0]);

        try {
            const res = await fetch(`${API_BASE}/clean`, { method: "POST", body: fd });
            const data = await res.json();

            previewAfter.innerHTML = createTable(data.preview_after);
            previewBefore.innerHTML = createTable(data.preview_before);
            previewSection.style.display = "block";
            
            // Scroll to preview
            previewSection.scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            alert("Error: Could not process file.");
            console.error(err);
        } finally {
            progress.style.display = "none";
        }
    };

    /* DOWNLOAD LOGIC */
    downloadBtn.onclick = async () => {
        try {
            // We call the download endpoint
            const res = await fetch(`${API_BASE}/download`);
            if (!res.ok) throw new Error("Download failed");
            
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "cleaned_data.xlsx"; // Adjust extension as needed
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (err) {
            alert("Error downloading file. Ensure the backend has a /download route.");
        }
    };

    /* MACRO LOGIC */
    macroExcelZone.onclick = () => macroExcel.click();
    macroBasZone.onclick = () => macroBas.click();
    macroExcel.onchange = () => macroExcelName.textContent = macroExcel.files[0]?.name || "";
    macroBas.onchange = () => macroBasName.textContent = macroBas.files[0]?.name || "";

    runMacroBtn.onclick = async () => {
        if (!macroExcel.files[0] || !macroBas.files[0]) {
            alert("Please upload both files");
            return;
        }
        const fd = new FormData();
        fd.append("excel", macroExcel.files[0]);
        fd.append("bas", macroBas.files[0]);

        try {
            const res = await fetch(`${API_BASE}/run-macro`, { method: "POST", body: fd });
            if(res.ok) alert("Macro executed successfully");
        } catch (err) {
            alert("Error running macro");
        }
    };
</script>
</body>
</html>
